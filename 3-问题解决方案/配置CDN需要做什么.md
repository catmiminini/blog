# 静态资源通过CDN托管流程

## CDN原理和工作流程

### 名词解释

- CNAME域名：配置CDN后要将部分请求转移至CDN处理，需要更改DNS配置，在域名服务商处配置CNAME将源站请求转移至CDN处理。
- DNS：域名解析服务
- 边缘节点：CDN内容分发网络的叶子节点，通常遍布在各个地理区域上，每个边缘节点存储着内容分发网络的缓存，并尽可能保持更新。用户的请求被转移到CDN网络上后，会找到地理位置上最近的边缘节点返回数据，这一过程通过CDN内部的DNS服务返回最终得到的边缘节点的IP来实现。
- 源站：业务的原始部署服务器，在外网上可以通过IP访问, 也可以通过域名访问。
- 域名服务商：业务原始服务器的域名是由域名服务商提供的，通过设置DNS的A记录和CNAME记录指定真实IP和真实域名。

### 使用场景

- 静态资源分发：网页/文件/图片加速
- 音视频点播：除了降低源站压力外，有的CDN会提供分段预取技术、以及防盗链技术。
- 动态加速：CDN使用内部链路快速转发动态请求到源站，最终请求还是由源站处理，CDN只是优化了路由转发的问题。

## CDN服务商的配置流程（以七牛为例）

### 配置信息

- 回源配置
  - 源站信息：资源的回源域名或IP，用户访问业务服务器输入的域名和IP，也是加速域名。
  - 回源host：CDN失效时请求资源的服务器的域名，默认是加速域名。
  - 回源协议：请求回源的协议
- 缓存配置
  - 缓存时间：资源内容的缓存过期时间规则
  - 忽略url参数：略
- 访问控制配置
  - referer防盗链：配置request header中的referer黑白名单，限制访问来源
  - 时间防盗链：设置密钥，配合签名过期时间控制资源的访问时限
  - 回源鉴权：配置回源验证策略，对CDN接收到的访问请求进行鉴权，适用于对防盗链有很高实时性要求的场景。
  - IP黑白名单：允许或禁止某些IP的访问。
- HTTPS配置
  - 开启HTTPS：绑定证书和HTTPS状态管理
  - 更换证书
  - 强制HTTPS：开启后HTTP请求会强制跳转到HTTPS，关闭时默认兼容用户的HTTP请求
- 流量带宽告警
  - 阈值告警：流量/带宽的阈值告警
- 图片优化
  - 图片自动瘦身
  - 图片处理

### 配置CDN的基础信息

1. 前提需要有一个可用源站 --- 域名已备案，可以做域名解析。
2. 在CDN中填写回源配置，包括源站信息，回源HOST, 回源协议等
3. 在CDN中配置缓存配置，包括缓存实际和不缓存URL等
4. 在CDN中配置HTTPS, 包括是否开启HTTPS，证书等
5. 在CDN中配置HTTP响应头：向客户端提供一些额外信息，比如谁在发送响应、响应者的功能

### 配置CNAME

CDN配置完成后，会提供一个CDN的域名，在域名服务商中将这个域名添加到CNAME记录中。

### 刷新预取

刷新预取主要是用于业务服务器上的资源更新后，CDN还未更新资源时，需要主动通知CDN进行资源更新。

- 刷新分为刷新文件、刷新目录两种方式，刷新文件是以文件为单位将缓存在CDN节点上对应的资源进行清除。刷新目录是以目录为单位，将目录下的所有缓存在CDN节点上的文件进行清除。文件预取是以文件为单位进行资源预热。
- 动态加速每次请求都会回源，因此该场景下不提供刷新预取服务。