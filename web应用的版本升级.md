# web应用的版本升级

## 浏览器应用的特点

浏览器应用是动态获取的, 浏览器作为平台, web应用以主机:端口作为应用id, 通过浏览器向用户提供服务. 所以web应用天生就不需要安装就可以使用. 此外web应用提供的服务完全由它所返回的html及相关的静态资源提供. 如果禁止浏览器使用缓存, 那么对用户来说, web应用的版本升级会直接在浏览器生效, 用户和开发者都不需要关注web应用更新的副作用.

## 实际场景下web应用升级的问题

在实际场景下, 现代浏览器往往默认开启了浏览器缓存, 这破坏了web应用无感更新的部分体验. 在浏览器缓存开启的情况下, web应用的入口html如果被缓存, 那么它相关的其他静态资源文件也都无法更新. 这种情况下, 只要html文件不失效, 那web应用就一直不会更新.

web应用不更新时, 会有问题吗? 答案是肯定的, 会产生问题. 比如前后端原有接口的参数和返回值的变化, 当web应用更新时, 前端和后端会同步更新, 但由于浏览器缓存, 导致前端未更新而后端更新, 此时再调用更新后的接口, 就会产生错误. 因此web应用更新需要处理浏览器缓存. 又比如web应用更新后替换了静态资源, 原有的静态资源被删除, 那么在旧版本的前端展示中, 就会出现404错误.

首先要说, 虽然浏览器缓存关闭后, web应用更新就不会有上述问题. 但浏览器缓存对web应用的体验至关重要, 能够大大提高响应速度, 并减少后端服务器的压力. 所以不应该用关闭浏览器缓存的方法来解决问题, 而是要配合浏览器缓存解决问题.

## 解决web应用升级的缓存问题的思路

配合浏览器缓存解决前端不更新的问题的思路, 就是要保证浏览器缓存总是新的.

我们已知浏览器缓存有两种, 强缓存和协商缓存. 强缓存是在有效期内可以直接使用的缓存, 而协商缓存是使用前都要向服务器确认的缓存.

看起来协商缓存是一直解决前端更新问题的方法. 但具体改怎么做呢?

首先我们区分一下前端的资源有哪些:

- html
- css
- js
- 图片和其他文件资源
- 后端接口返回的动态数据

这些资源中, 一般情况下, 除了后端接口返回的动态数据一般不缓存以外, 其他的包括html, css, js, 图片等静态资源都可以缓存.

为了便于我们理清解决方案, 我们假设项目中已经配置了以下缓存:

- 强缓存: html, css, js, 图片等文件静态资源
- 不缓存: 接口动态数据

我们可知, 在上面的假设条件下, 我们的wen应用在更新时就会出现上面的问题, 现在我们尝试用协商缓存解决它.

当用户访问web应用时, 首先是访问到html文件, 如果html文件被缓存了, 那后续访问的都是旧版本的资源, 所以首先要保证html文件不被缓存. 此时修改我们的缓存策略

- 协商缓存: html
- 强缓存: css, js, 图片等文件静态资源
- 不缓存: 接口动态数据

调整后, 用户每次打开此web应用都会验证html是否是最新的. 如果版本未更新, 那么协商缓存返回304, 使用缓存的html; 如果版本已更新, 那么协商缓存返回200, 更新缓存的html并使用新的html.

使用新的html也会联动这加载更新后的其他静态资源(css, js, 图片), 而前端接口实现取决于js, 当js更新后, 前端接口部分也会更新. 所以只需要对html使用协商缓存就可以解决web应用更新时的缓存问题.

这样就完成了吗? 还有两个问题...

一是css, js, 图片等文件静态资源使用的强缓存, 在html文件更新后, 它们也不一定会更新. 强缓存情况下, 缓存只有一个过期的限制, 浏览器是通过文件名来寻找缓存的. 比如有一个web应用从版本1升级到版本2, 对应的从html1升级到html2; 再假设此次升级更换了logo(文件名: logo.svg), 在html1之前加载时, logo.svg已被缓存, html2中尝试加载logo.svg时, 由于文件名未发生变化, 所以使用缓存中的logo文件, 此时出现了logo文件未更新的问题.

类似的css, js等其他类型的文件, 也可能因为文件名称相同的原因导致升级后未更新的情况出现. 一种解决方法是打包时, 对静态资源的名称进行hash处理, 保证每次打包后的静态资源名称不一样, 这样就不会有新的html引用旧的静态资源的问题. 这样会有一个问题, 如果图片类的静态资源特别多该怎么办, 每次打包时都要重新进行hash吗? 这种情况下是不可能每次都重新打包的, 因此如果为了图片的绝对实时性, 我们需要对所有图片使用协商缓存. 但其实我们不需要这么做, 我们只需要保证每次新增的图片hash文件名不重复就可以. 如果html使用了新的图片, 那么图片文件名的变化会导致新图片替换老图片. 但旧图片依然需要保存到数据库中, 可以等版本更新一段时间后, 之前所有的强缓存都失效以后(服务端设置的缓存时间, 所以服务端是知道所有强缓存何时过期的), 将服务器旧版本的不再使用的图片删除掉.


结论:

- 协商缓存: html
- 强缓存: css js 打包时使用hash文件名, 打包时当即清除旧的css和js
- 强缓存: 新增的图片文件使用新的hash文件, 旧的图片文件等待强缓存过期后清除.
- 协商缓存: 当css js 图片的强缓存失效后, 使用协商缓存更新缓存.

## 服务器如何配置
// TODO: 先学习下nginx配置
以nginx服务器为例

```
http
{

  ...
  server { ... }
}

```